---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { db } from '../../db/client';
import Breadcrumbs from '../../components/ui/Breadcrumbs.astro';

// 1. Generate Static Paths for all methods
export async function getStaticPaths() {
	const methods = db.prepare('SELECT * FROM payment_methods').all();
	return methods.map((m: any) => ({
		params: { id: m.id },
		props: { method: m },
	}));
}

const { method } = Astro.props;

// 2. Fetch Casinos that accept this method
const acceptingCasinos = db
	.prepare(
		`
    SELECT c.id, c.name, c.logo_url, c.bonus_offer, c.payout_speed_minutes
    FROM casinos c
    JOIN casino_payment_methods cpm ON c.id = cpm.casino_id
    WHERE cpm.method_id = ?
`
	)
	.all(method.id) as any[];

const pros = JSON.parse(method.pros || '[]');
const cons = JSON.parse(method.cons || '[]');
---

<BaseLayout
	title={`Best ${method.name} Casinos Canada | Fast Payouts (2024)`}
	description={`Find the best online casinos in Canada that accept ${method.name}. Fast withdrawals, low fees, and secure transactions.`}
>
    <div class="container mx-auto px-4 pt-6 pb-12">
        <Breadcrumbs
            items={[
                { text: 'Banking', href: '/banking' },
                { text: method.name, href: Astro.url.pathname },
            ]}
        />

        <div class="bg-slate-900 text-white p-8 md:p-12 rounded-3xl shadow-lg mt-6 relative overflow-hidden">
            <div class='flex flex-col md:flex-row items-center gap-8 relative z-10'>
                <!-- Logo Card -->
                <div class='bg-white p-6 rounded-2xl shadow-xl w-32 h-32 flex items-center justify-center flex-shrink-0'>
                    <img src={method.logo_url} alt={method.name} class='max-w-full max-h-full object-contain' />
                </div>

                <!-- Hero Text -->
                <div class='text-center md:text-left'>
                    <h1 class='text-3xl md:text-5xl font-black mb-4'>
                        Best <span class='text-blue-400'>{method.name}</span> Casinos
                    </h1>
                    <p class='text-slate-300 text-lg max-w-2xl'>
                        {method.description}
                    </p>
                </div>

                <!-- Key Stats -->
                <div class="flex gap-4 mt-6 md:mt-0 md:ml-auto">
                    <div class="text-center bg-white/10 p-4 rounded-xl border border-white/10 backdrop-blur-sm min-w-[100px]">
                        <span class="block text-slate-400 text-xs font-bold uppercase mb-1">Speed</span>
                        <span class="text-lg font-bold">{method.avg_speed}</span>
                    </div>
                    <div class="text-center bg-white/10 p-4 rounded-xl border border-white/10 backdrop-blur-sm min-w-[100px]">
                        <span class="block text-slate-400 text-xs font-bold uppercase mb-1">Fees</span>
                        <span class="text-lg font-bold">{method.fees}</span>
                    </div>
                </div>
            </div>
        </div>
	</div>

	<div class='container mx-auto px-4 -mt-10 relative z-10 space-y-12 mb-12'>
		<!-- Pros & Cons -->
        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span class="text-green-500">üëç</span> Pros
                </h3>
                <ul class="space-y-2">
                    {pros.map((p: string) => (
                        <li class="flex items-start gap-2 text-gray-600 text-sm">
                            <span class="text-green-500 font-bold">‚úì</span> {p}
                        </li>
                    ))}
                </ul>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-red-500">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span class="text-red-500">üëé</span> Cons
                </h3>
                <ul class="space-y-2">
                    {cons.map((c: string) => (
                        <li class="flex items-start gap-2 text-gray-600 text-sm">
                            <span class="text-red-500 font-bold">√ó</span> {c}
                        </li>
                    ))}
                </ul>
            </div>
        </div>

		<!-- The LIST -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                 <h2 class="font-bold text-xl text-gray-900">Casinos accepting {method.name}</h2>
                 <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">{acceptingCasinos.length} Found</span>
            </div>
            
            <div class="divide-y divide-gray-100">
                {acceptingCasinos.map((casino: any) => (
                    <div class="p-4 md:p-6 flex flex-col md:flex-row items-center gap-6 hover:bg-blue-50/50 transition-colors">
                        <!-- Casino Identity -->
                        <div class="flex items-center gap-4 flex-1 w-full md:w-auto">
                            <img src={casino.logo_url} alt={casino.name} class="w-16 h-16 rounded-xl object-contain bg-white border border-gray-100 shadow-sm" />
                            <div>
                                <h3 class="font-bold text-lg text-gray-900">{casino.name}</h3>
                                <div class="flex items-center gap-2 text-xs text-green-600 font-medium bg-green-50 px-2 py-1 rounded w-fit mt-1">
                                    <span>‚è± Payout: {casino.payout_speed_minutes}m</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bonus -->
                        <div class="text-center md:text-left flex-1">
                            <span class="block text-xs uppercase text-gray-400 font-bold">Welcome Bonus</span>
                            <span class="font-bold text-gray-900">{casino.bonus_offer}</span>
                        </div>

                        <!-- CTA -->
                        <div class="w-full md:w-auto">
                            <a href={`/reviews/${casino.id}`} class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                                Review & Play
                            </a>
                        </div>
                    </div>
                ))}
            </div>
        </div>
	</div>
</BaseLayout>
