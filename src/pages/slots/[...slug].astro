---
// src/pages/slots/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { db } from '../../db/client';
import Breadcrumbs from '../../components/ui/Breadcrumbs.astro';

// 1. Define the Interface (Matches your DB columns + Provider Name alias)
interface SlotSql {
	slug: string;
	title: string;
	provider_id: string;
	provider_name: string; // From the JOIN
	rtp: number;
	volatility: string;
	max_win: string;
	paylines: string;
	release_date: string;
	description: string;
	image_url: string; // Note: DB uses image_url, not image
	featured: number;
}

// 2. Generate Pages at Build Time using Database
export async function getStaticPaths() {
	// Query all slots and join with provider name to get "NetEnt" instead of "netent"
	const slots = db
		.prepare(
			`
    SELECT slots.*, software_providers.name as provider_name 
    FROM slots 
    JOIN software_providers ON slots.provider_id = software_providers.id
  `
		)
		.all() as SlotSql[];

	return slots.map((slot) => ({
		params: { slug: slot.slug },
		props: { slot },
	}));
}

// 3. Get the data for the current page
const { slot } = Astro.props;
---

<BaseLayout
	title={`${slot.title} Free Demo | Play Online in Canada`}
	description={`Play ${slot.title} by ${slot.provider_name} for free. RTP: ${slot.rtp}%, Volatility: ${slot.volatility}. No download required.`}
>
	<div class='container mx-auto px-4 py-8'>
		<Breadcrumbs
			items={[
				{ text: 'Free Slots', href: '/slots' },
				{ text: slot.title, href: Astro.url.pathname },
			]}
		/>
	</div>

	<div class='container mx-auto px-4 py-8'>
		<div class='grid grid-cols-1 lg:grid-cols-3 gap-8'>
			<div class='lg:col-span-2 space-y-8'>
				<div>
					<h1 class='text-3xl md:text-4xl font-bold text-gray-900 mb-2'>
						{slot.title}
					</h1>
					<div class='flex items-center gap-4 text-sm text-gray-600'>
						<span class='flex items-center gap-1'>
							<svg
								class='w-4 h-4'
								fill='none'
								stroke='currentColor'
								viewBox='0 0 24 24'
							>
								<path
									stroke-linecap='round'
									stroke-linejoin='round'
									stroke-width='2'
									d='M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10'
								></path>
							</svg>
							{slot.provider_name}
						</span>
						<span class='w-1 h-1 bg-gray-400 rounded-full'></span>
						<span>{slot.release_date}</span>
					</div>
				</div>

				<div
					class='aspect-video bg-black rounded-xl overflow-hidden shadow-2xl relative group'
				>
					<img
						src={slot.image_url}
						alt={slot.title}
						class='w-full h-full object-cover opacity-60 group-hover:opacity-40 transition-opacity'
						loading='lazy'
						onerror="this.style.display='none'"
					/>

					<div
						class='absolute inset-0 flex flex-col items-center justify-center'
					>
						<button
							class='bg-red-600 hover:bg-red-700 text-white text-lg font-bold py-4 px-10 rounded-full shadow-lg transform hover:scale-105 transition-all flex items-center gap-2'
						>
							<svg class='w-8 h-8' fill='currentColor' viewBox='0 0 20 20'>
								<path
									d='M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z'
								></path>
							</svg>
							PLAY DEMO
						</button>
						<p class='text-white mt-4 text-sm font-medium opacity-90'>
							Click to load game (Age 19+)
						</p>
					</div>
				</div>

				<div
					class='bg-blue-50 border border-blue-100 p-6 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4'
				>
					<div>
						<h3 class='font-bold text-blue-900 text-lg'>
							Ready to play for real?
						</h3>
						<p class='text-blue-700 text-sm'>
							Get 100% Match Bonus up to $500 at our top rated casino.
						</p>
					</div>
					<a
						href='/reviews/bitstarz'
						class='bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg whitespace-nowrap transition-colors'
					>
						Play for Real Money
					</a>
				</div>

				<article class='prose max-w-none'>
					<h2>About {slot.title}</h2>
					<p>{slot.description}</p>
					<p>
						<strong>{slot.title}</strong> is a premium video slot from {
							slot.provider_name
						}. It features a Return to Player (RTP) of {slot.rtp}% and is
						classified as a {slot.volatility} volatility game.
					</p>
					<h3>Game Features</h3>
					<ul>
						<li><strong>Max Win:</strong> {slot.max_win} your stake.</li>
						<li><strong>Paylines:</strong> {slot.paylines}</li>
					</ul>
				</article>
			</div>
		</div>
	</div>
</BaseLayout>
