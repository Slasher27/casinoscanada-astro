---
// src/pages/slots/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { db } from '../../db/client';
import Breadcrumbs from '../../components/ui/Breadcrumbs.astro';
import EntityHero from '../../components/common/EntityHero.astro'; // Direct Import
import SlotSpecs from '../../components/slots/SlotSpecs.astro';
import SidebarCasinos from '../../components/ui/SidebarCasinos.astro';

// 1. Define the Interface
interface SlotSql {
	slug: string;
	title: string;
	provider_id: string;
	provider_name: string;
	rtp: number;
	volatility: string;
	max_win: string;
	paylines: string;
	release_date: string;
	description: string;
	image_url: string;
	featured: number;
	min_bet: number;
	max_bet: number;
	layout: string;
	features: string; // JSON string
}

// 2. Generate Pages
export async function getStaticPaths() {
	const slots = db
		.prepare(
			`
    SELECT slots.*, software_providers.name as provider_name 
    FROM slots 
    JOIN software_providers ON slots.provider_id = software_providers.id
  `
		)
		.all() as SlotSql[];

	return slots.map((slot) => ({
		params: { slug: slot.slug },
		props: { slot },
	}));
}

const { slot } = Astro.props;

// 3. Smart Recommender: Find a casino that actually has this provider
const recommendedCasino = db
	.prepare(
		`
    SELECT c.name, c.bonus_offer, c.id 
    FROM casinos c
    JOIN casino_software cs ON c.id = cs.casino_id
    WHERE cs.provider_id = ?
    LIMIT 1
`
	)
	.get(slot.provider_id) as
	| { name: string; bonus_offer: string; id: string }
	| undefined;

// Fallback if no specific match found (use Bitstarz as default high quality option)
const ctaCasino = recommendedCasino || {
	name: 'Bitstarz',
	bonus_offer: '5 BTC Welcome Package',
	id: 'bitstarz',
};

// Schema.org Data
const schema = {
	'@context': 'https://schema.org',
	'@type': 'SoftwareApplication',
	name: slot.title,
	applicationCategory: 'Game',
	operatingSystem: 'Any',
	offers: {
		'@type': 'Offer',
		price: '0',
		priceCurrency: 'CAD',
		availability: 'https://schema.org/InStock',
	},
	author: {
		'@type': 'Organization',
		name: slot.provider_name,
	},
	description: slot.description,
};
---

<BaseLayout
	title={`${slot.title} Free Demo | Play Online in Canada`}
	description={`Play ${slot.title} by ${slot.provider_name} for free. RTP: ${slot.rtp}%, Volatility: ${slot.volatility}. No download required.`}
>
	<!-- Add JsonLD -->
	<script
		type='application/ld+json'
		slot='head'
		set:html={JSON.stringify(schema)}
	/>

	<div class='container mx-auto px-4 py-8'>
		<Breadcrumbs
			items={[
				{ text: 'Free Slots', href: '/slots' },
				{ text: slot.title, href: Astro.url.pathname },
			]}
		/>

		<div class='mt-6'>
			<EntityHero
				title={slot.title}
				subtitle={`Video Slot by ${slot.provider_name}`}
				imageUrl={slot.image_url}
				variant='game'
				stats={[
					{
						label: 'RTP',
						value: `${slot.rtp}%`,
						icon: 'ðŸ“ˆ',
						color: 'text-green-400',
					},
					{
						label: 'Mode',
						value: 'Free Demo',
						icon: 'â­',
						color: 'text-amber-400',
					},
				]}
			/>
		</div>

		<div class='grid grid-cols-1 lg:grid-cols-12 gap-12'>
			<!-- Main Content -->
			<main class='lg:col-span-8 space-y-8'>
				<!-- Demo Game Window -->
				<div
					class='aspect-video bg-black rounded-xl overflow-hidden shadow-2xl relative group border-4 border-slate-800'
				>
					<img
						src={slot.image_url}
						alt={slot.title}
						class='w-full h-full object-cover opacity-60 group-hover:opacity-40 transition-opacity'
						loading='lazy'
					/>

					<div
						class='absolute inset-0 flex flex-col items-center justify-center'
					>
						<button
							onclick="alert('Demo loader would trigger here. Implemented in Phase 3.')"
							class='bg-red-600 hover:bg-red-700 text-white text-lg font-bold py-4 px-10 rounded-full shadow-lg transform hover:scale-105 transition-all flex items-center gap-2'
						>
							<svg class='w-8 h-8' fill='currentColor' viewBox='0 0 20 20'>
								<path
									d='M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z'
								></path>
							</svg>
							PLAY DEMO
						</button>
						<p
							class='text-white mt-4 text-sm font-medium opacity-90 drop-shadow-md'
						>
							Confirm your age (19+) to play
						</p>
					</div>
				</div>

				<!-- CTA Box -->
				<div
					class='bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-6 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4 shadow-sm'
				>
					<div>
						<h3 class='font-bold text-blue-900 text-lg'>
							Play {slot.title} for Real Money?
						</h3>
						<p class='text-blue-700 text-sm'>
							We recommend <strong class='text-blue-900'
								>{ctaCasino.name}</strong
							> for {slot.provider_name} games.
							<br />
							<span class='text-xs opacity-75'
								>Bonus: {ctaCasino.bonus_offer}</span
							>
						</p>
					</div>
					<a
						href={`/reviews/${ctaCasino.id}`}
						class='bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg whitespace-nowrap transition-colors shadow-md transform hover:-translate-y-0.5'
					>
						Play at {ctaCasino.name}
					</a>
				</div>

				<!-- Editorial Content -->
				<article
					class='prose prose-lg max-w-none prose-headings:font-bold prose-blue'
				>
					<h2>About the Game</h2>
					<p>{slot.description}</p>
					<p>
						<strong>{slot.title}</strong> is a high-quality video slot developed by
						the renowned {slot.provider_name}. It hit the markets on {
							slot.release_date
						} and has since become a favorite for its {slot.rtp}% RTP and {
							slot.volatility
						} volatility profile.
					</p>

					<h3>Theme and Design</h3>
					<p>
						The game features a {slot.layout || 'standard'} grid layout with {
							slot.paylines
						} paylines. Players can chase the maximum win of {slot.max_win}.
					</p>

					<h3>Key Features</h3>
					{
						slot.features ? (
							<ul>
								{JSON.parse(slot.features).map((feat: string) => (
									<li>
										<strong>{feat}</strong>
									</li>
								))}
							</ul>
						) : (
							<p>Standard slot features included.</p>
						)
					}
				</article>
			</main>

			<!-- Sidebar -->
			<aside class='lg:col-span-4 space-y-8'>
				<div class='sticky top-8 space-y-8'>
					<SlotSpecs
						rtp={slot.rtp}
						volatility={slot.volatility}
						maxWin={slot.max_win}
						paylines={slot.paylines}
						layout={slot.layout}
						minBet={slot.min_bet}
						maxBet={slot.max_bet}
						releaseDate={slot.release_date}
					/>

					<SidebarCasinos />
				</div>
			</aside>
		</div>
	</div>
</BaseLayout>
