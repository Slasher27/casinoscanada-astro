---
import BaseLayout from '../layouts/BaseLayout.astro';
import ComparisonEngine from '../components/interactive/ComparisonEngine.svelte';
import { db } from '../db/client';

// 1. Fetch All Data
const casinos = db.prepare('SELECT * FROM casinos ORDER BY name ASC').all();

// 2. Fetch Relations
const casinoIds = casinos.map((c) => c.id);
const placeholders = casinoIds.map(() => '?').join(',');

const allPayments = db
	.prepare(
		`
    SELECT cpm.casino_id, pm.id, pm.name, pm.logo_url
    FROM casino_payment_methods cpm
    JOIN payment_methods pm ON cpm.method_id = pm.id
    WHERE cpm.casino_id IN (${placeholders})
`
	)
	.all(...casinoIds);

const allSoftware = db
	.prepare(
		`
    SELECT cs.casino_id, sp.id, sp.name, sp.logo_url
    FROM casino_software cs
    JOIN software_providers sp ON cs.provider_id = sp.id
    WHERE cs.casino_id IN (${placeholders})
`
	)
	.all(...casinoIds);

// 3. Enrich Data structure for Client
const enrichedCasinos = casinos.map((c) => ({
	...c,
	payments: allPayments.filter((p) => p.casino_id === c.id),
	software: allSoftware.filter((s) => s.casino_id === c.id),
}));
---

<BaseLayout
	title='Casino Comparison Tool | Compare Bonuses & Speed'
	description='Compare the best online casinos in Canada side-by-side. Analyze bonuses, payout speeds, and game libraries to find your perfect match.'
>
	<!-- Hero / Header -->
	<div class='bg-slate-900 text-white py-12'>
		<div class='container mx-auto px-4 text-center'>
			<h1 class='text-3xl md:text-5xl font-black mb-4'>
				Casino <span class='text-red-600'>Comparison</span> Tool
			</h1>
			<p class='text-slate-300 max-w-2xl mx-auto text-lg'>
				Not sure which casino to pick? Put them head-to-head and see who offers
				the best value for your money.
			</p>
		</div>
	</div>

	<div class='bg-gray-50 min-h-screen'>
		<ComparisonEngine client:only='svelte' allCasinos={enrichedCasinos} />
	</div>
</BaseLayout>
