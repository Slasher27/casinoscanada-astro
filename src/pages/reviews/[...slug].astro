---
import { getCollection } from 'astro:content';
import ReviewLayout from '../../layouts/ReviewLayout.astro'; // <--- Switch import
import { db } from '../../db/client';

// 1. getStaticPaths (No change needed)
export async function getStaticPaths() {
	const reviews = await getCollection('reviews');
	return reviews.map((entry) => ({
		params: { slug: entry.slug },
		props: { entry },
	}));
}

const { entry } = Astro.props;
// NEW: Extract 'headings' from the render function
const { Content, headings } = await entry.render();

// ... (Keep your existing DB Fetch Logic for owner/license/badges) ...
const stmt = db.prepare('SELECT * FROM casinos WHERE id = ?');
const casinoData = stmt.get(entry.data.casinoId) as any;
// ... (Define owner, license, realPayout variables) ...
// (If you deleted them, I can paste the full block again)
const owner = casinoData ? casinoData.owner : 'Unknown';
const license = casinoData ? casinoData.license : 'Unknown';
const realPayout = casinoData
	? `${casinoData.payout_speed_minutes} Mins`
	: entry.data.payoutTime;
---

<ReviewLayout frontmatter={entry.data} headings={headings}>
	<script
		type='application/ld+json'
		slot='head'
		set:html={JSON.stringify({
			'@context': 'https://schema.org/',
			'@type': 'Review',
			itemReviewed: {
				'@type': 'Casino',
				name: entry.data.title,
			},
			reviewRating: {
				'@type': 'Rating',
				ratingValue: entry.data.rating,
			},
			author: {
				'@type': 'Organization',
				name: entry.data.author,
			},
		})}
	/>

	<div class='mb-8 border-b border-gray-200 pb-8'>
		<h1 class='text-4xl font-bold mb-4'>{entry.data.title}</h1>

		<div class='flex flex-wrap gap-3 text-sm font-medium'>
			<span
				class='bg-blue-100 text-blue-800 px-3 py-1 rounded-full border border-blue-200'
				>Owner: <strong>{owner}</strong></span
			>
			<span
				class='bg-green-100 text-green-800 px-3 py-1 rounded-full border border-green-200'
				>Avg Payout: <strong>{realPayout}</strong></span
			>
		</div>
	</div>

	<div class='prose prose-lg prose-slate max-w-none'>
		<Content />
	</div>
</ReviewLayout>
