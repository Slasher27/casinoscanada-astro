---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/ui/Breadcrumbs.astro';
import CasinoGridCard from '../../components/ui/CasinoGridCard.astro';
import Container from '../../components/common/Container.astro';
import { db } from '../../db/client';

// 1. Get all markdown reviews
const reviews = await getCollection('reviews');

// 2. Get all casino data (Enriched with Relations)
const topCasinosRaw = db.prepare('SELECT * FROM casinos').all() as any[];
const casinoIds = topCasinosRaw.map((c) => c.id);

let allPayments: any[] = [];
let allSoftware: any[] = [];

if (casinoIds.length > 0) {
	const placeholders = casinoIds.map(() => '?').join(',');

	// Fetch Payments
	allPayments = db
		.prepare(
			`
        SELECT cpm.casino_id, pm.id, pm.name, pm.logo_url
        FROM casino_payment_methods cpm
        JOIN payment_methods pm ON cpm.method_id = pm.id
        WHERE cpm.casino_id IN (${placeholders})
    `
		)
		.all(...casinoIds) as any[];

	// Fetch Software
	allSoftware = db
		.prepare(
			`
        SELECT cs.casino_id, sp.id, sp.name, sp.logo_url
        FROM casino_software cs
        JOIN software_providers sp ON cs.provider_id = sp.id
        WHERE cs.casino_id IN (${placeholders})
    `
		)
		.all(...casinoIds) as any[];
}

// Map enriched data by ID for easy lookup
const casinoMap = new Map(
	topCasinosRaw.map((c) => {
		return [
			c.id,
			{
				...c,
				payments: allPayments.filter((p) => p.casino_id === c.id),
				software: allSoftware.filter((s) => s.casino_id === c.id),
			},
		];
	})
);

const breadcrumbs = [{ text: 'Casino Reviews', href: '/reviews' }];

// SEO: CollectionPage Schema
const schema = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: 'Trusted Online Casino Reviews Canada',
	description:
		'Read honest, expert reviews of the best online casinos in Canada. We test withdrawal speeds, bonuses, and safety.',
	url: 'https://casinoscanada.online/reviews',
	mainEntity: {
		'@type': 'ItemList',
		itemListElement: reviews.map((review, index) => ({
			'@type': 'ListItem',
			position: index + 1,
			url: `https://casinoscanada.online/reviews/${review.slug}`,
			name: review.data.title,
		})),
	},
};
---

<BaseLayout
	title='Best Online Casino Reviews Canada (2025) | Safe & Tested'
	description='Browse our honest reviews of the top online casinos in Canada. We test payout speeds, bonus terms, and safety so you can play with confidence.'
>
	<!-- Schema Injection -->
	<script
		type='application/ld+json'
		set:html={JSON.stringify(schema)}
		slot='head'
	/>

	<Container>
		<div class='mb-6'>
			<Breadcrumbs items={breadcrumbs} />
		</div>

		<div
			class='bg-slate-900 text-white min-h-[300px] flex flex-col justify-center items-center px-6 py-12 text-center rounded-3xl shadow-lg mb-12 relative overflow-hidden'
		>
			<!-- GEO Context: Canada Flag Background (Subtle) -->
			<div
				class='absolute top-0 right-0 opacity-5 pointer-events-none transform translate-x-1/4 -translate-y-1/4'
			>
				<svg viewBox='0 0 512 512' class='w-96 h-96 fill-current text-white'
					><path
						d='M495.9 191.7L416.7 192l5.4-85-115.4 78.6L256 0 205.3 185.6 90 107l5.4 85L16.1 191.7C-5.6 193.3-5.2 225 16.5 225h155.6l-26.6 287h221l-26.6-287h155.6c21.7 0 22.1-31.7 .4-33.3z'
					></path></svg
				>
			</div>

			<h1
				class='text-4xl md:text-6xl font-black mb-6 tracking-tight relative z-10'
			>
				Honest <span class='text-red-500'>Casino Reviews</span> ðŸ‡¨ðŸ‡¦
			</h1>
			<p
				class='text-xl text-slate-300 max-w-2xl mx-auto leading-relaxed relative z-10'
			>
				<span
					class='inline-flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full text-sm font-bold text-white mb-2 border border-slate-700'
				>
					<span class='text-red-500'>âœ”</span> Trusted by Canadians
				</span>
				<br />
				We don't rely on guesswork. We have personally tested <strong
					>{reviews.length} casinos</strong
				> for licensing, payout speeds, and fairness to ensure you play safely.
			</p>
		</div>

		<!-- Reviews Grid (Updated Layout) -->
		<div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6'>
			{
				reviews.map((review, index) => {
					const casino = casinoMap.get(review.data.casinoId);

					// Fail gracefully if casino data is missing (should verify db consistency)
					if (!casino) return null;

					return (
						<CasinoGridCard casino={casino} review={review} index={index} />
					);
				})
			}
		</div>
	</Container>
</BaseLayout>
