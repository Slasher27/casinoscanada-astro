---
import { getCollection } from 'astro:content';
import ListingLayout from '../../layouts/ListingLayout.astro';
import Breadcrumbs from '../../components/ui/Breadcrumbs.astro';
import CasinoGridCard from '../../components/ui/CasinoGridCard.astro';
import { getAllCasinos, getCasinosWithRelations } from '../../db/queries';

// 1. Get all markdown reviews
const reviews = await getCollection('reviews');

// 2. Get all casino data with relationships
const topCasinosRaw = getAllCasinos();
const casinoIds = topCasinosRaw.map((c) => c.id);
const enrichedCasinos = getCasinosWithRelations(casinoIds);

// Map enriched data by ID for easy lookup
const casinoMap = new Map(enrichedCasinos.map((c) => [c.id, c]));

const breadcrumbs = [{ text: 'Casino Reviews', href: '/reviews/' }];

// SEO: CollectionPage Schema
const schema = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: 'Trusted Online Casino Reviews Canada',
	description:
		'Read honest, expert reviews of the best online casinos in Canada. We test withdrawal speeds, bonuses, and safety.',
	url: 'https://casinoscanada.online/reviews',
	mainEntity: {
		'@type': 'ItemList',
		itemListElement: reviews.map((review, index) => ({
			'@type': 'ListItem',
			position: index + 1,
			url: `https://casinoscanada.online/reviews/${review.slug}`,
			name: review.data.title,
		})),
	},
};
---

<ListingLayout
	title='Best Online Casino Reviews Canada (2025) | Safe & Tested'
	description='Browse our honest reviews of the top online casinos in Canada. We test payout speeds, bonus terms, and safety so you can play with confidence.'
	breadcrumbs={breadcrumbs}
>
	<!-- Schema Injection -->
	<script
		type='application/ld+json'
		set:html={JSON.stringify(schema)}
		slot='head'
	/>

	<div slot='hero' class='relative z-10 max-w-4xl mx-auto'>
		<!-- GEO Context: Canada Flag Background (Subtle) -->
		<div
			class='absolute top-0 right-0 opacity-5 pointer-events-none transform translate-x-1/2 -translate-y-1/2'
		>
			<svg viewBox='0 0 512 512' class='w-96 h-96 fill-current text-white'>
				<path
					d='M495.9 191.7L416.7 192l5.4-85-115.4 78.6L256 0 205.3 185.6 90 107l5.4 85L16.1 191.7C-5.6 193.3-5.2 225 16.5 225h155.6l-26.6 287h221l-26.6-287h155.6c21.7 0 22.1-31.7 .4-33.3z'
				></path>
			</svg>
		</div>

		<h1
			class='text-4xl md:text-6xl font-black mb-6 tracking-tight relative z-10'
		>
			Honest <span class='text-red-500'>Casino Reviews</span> ðŸ‡¨ðŸ‡¦
		</h1>
		<p class='text-xl text-slate-300 mx-auto leading-relaxed relative z-10'>
			<span
				class='inline-flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full text-sm font-bold text-white mb-4 border border-slate-700'
			>
				<span class='text-red-500'>âœ”</span> Trusted by Canadians
			</span>
			<br />
			We don't rely on guesswork. We have personally tested <strong
				class='text-white'>{reviews.length} casinos</strong
			> for licensing, payout speeds, and fairness to ensure you play safely.
		</p>
	</div>

	<!-- Reviews Grid -->
	<div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6'>
		{
			reviews.map((review, index) => {
				const casino = casinoMap.get(review.data.casinoId);

				// Fail gracefully if casino data is missing (should verify db consistency)
				if (!casino) return null;

				return <CasinoGridCard casino={casino} review={review} index={index} />;
			})
		}
	</div>
</ListingLayout>
