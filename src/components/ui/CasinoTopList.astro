---
import { db } from '../../db/client';

// 1. Define Types
type PaymentMethod = {
	id: string;
	name: string;
	logo_url: string;
};

type Casino = {
	id: string;
	name: string;
	website_url: string;
	payout_ratio: number;
	payout_speed_minutes: number;
	logo_url?: string;
	bonus_offer?: string;
	bonus_spins?: number;
	payments?: PaymentMethod[];
};

// 2. Fetch Top 10 Casinos
const topCasinosRaw = db
	.prepare('SELECT * FROM casinos ORDER BY payout_ratio DESC LIMIT 10')
	.all() as Casino[];

// 3. Fetch Payments
const casinoIds = topCasinosRaw.map((c) => c.id);
let allPayments: (PaymentMethod & { casino_id: string })[] = [];

if (casinoIds.length > 0) {
	// Determine which placeholder to use based on DB driver
	const placeholders = casinoIds.map(() => '?').join(',');

	const paymentQuery = `
    SELECT cpm.casino_id, pm.id, pm.name, pm.logo_url
    FROM casino_payment_methods cpm
    JOIN payment_methods pm ON cpm.method_id = pm.id
    WHERE cpm.casino_id IN (${placeholders})
    `;

	allPayments = db.prepare(paymentQuery).all(...casinoIds) as any[];
}

// 4. Map & Sort
const topCasinos = topCasinosRaw.map((casino) => {
	const methods = allPayments.filter((p) => p.casino_id === casino.id);
	const priority = ['interac', 'bitcoin', 'visa', 'mastercard', 'idebit'];

	const sortedMethods = methods.sort((a, b) => {
		const indexA = priority.indexOf(a.id);
		const indexB = priority.indexOf(b.id);
		if (indexA !== -1 && indexB !== -1) return indexA - indexB;
		if (indexA !== -1) return -1;
		if (indexB !== -1) return 1;
		return 0;
	});

	return { ...casino, payments: sortedMethods.slice(0, 5) };
});

// FIXED: Base64 encoded Shield Icon (Safe for 'onerror' attributes)
const FALLBACK_ICON =
	'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzlDQTNBRiI+PHBhdGggZD0iTTEyIDFMMyA1djZjMCA1LjU1IDMuODQgMTAuNzQgOSAxMiA1LjE2LTEuMjYgOS02LjQ1IDktMTJWNWwtOS00em0wIDEwLjk5aDdjLS41MyA0LjEyLTMuMjggNy43OS03IDguOTRWMTJINVY2LjNsNy0zLjExdjguOHoiLz48L3N2Zz4=';
---

<div class='flex flex-col gap-4'>
	<div
		class='hidden md:grid grid-cols-12 gap-4 bg-gray-100 p-4 rounded-t-xl text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200'
	>
		<div class='col-span-1 text-center'>Rank</div>
		<div class='col-span-5'>Casino & Banking</div>
		<div class='col-span-3 text-center'>Bonus</div>
		<div class='col-span-1 text-center'>Payout</div>
		<div class='col-span-2 text-center'>Action</div>
	</div>

	{
		topCasinos.map((casino, index) => (
			<div class='bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow'>
				<div class='md:hidden p-5 flex flex-col gap-4'>
					<div class='flex items-center gap-4'>
						<div class='relative'>
							<div class='w-16 h-16 bg-gray-50 rounded-xl border border-gray-100 flex items-center justify-center p-2'>
								<img
									src={casino.logo_url || FALLBACK_ICON}
									alt={casino.name}
									class='w-full h-full object-contain'
									onerror={`this.onerror=null; this.src='${FALLBACK_ICON}';`}
								/>
							</div>
							<div class='absolute -top-2 -left-2 w-6 h-6 bg-slate-900 text-white text-xs font-bold rounded-full flex items-center justify-center'>
								{index + 1}
							</div>
						</div>
						<div>
							<h3 class='text-xl font-bold text-slate-900 leading-none'>
								{casino.name}
							</h3>
							<div class='flex items-center gap-2 mt-2 text-sm text-green-600 font-bold'>
								<span>âš¡ {casino.payout_speed_minutes} mins</span>
								<span class='text-gray-300'>|</span>
								<span>98% Score</span>
							</div>
						</div>
					</div>

					<div class='bg-yellow-50 border border-yellow-100 rounded-lg p-3 text-center'>
						<span class='block text-xs font-bold text-yellow-700 uppercase tracking-wide mb-1'>
							Welcome Bonus
						</span>
						<span class='block text-lg font-black text-slate-900'>
							{casino.bonus_offer}
						</span>
					</div>

					<div class='flex items-center justify-between border-t border-gray-100 pt-3'>
						<div class='flex -space-x-2'>
							{casino.payments &&
								casino.payments.map((pm) => (
									<div
										class='w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center relative z-0 hover:z-10 bg-white'
										title={pm.name}
									>
										<img
											src={pm.logo_url}
											alt={pm.name}
											class='w-5 h-5 object-contain'
											loading='lazy'
											onerror={`this.onerror=null; this.src='${FALLBACK_ICON}';`}
										/>
									</div>
								))}
						</div>
						<a
							href={`/reviews/${casino.id}-casino`}
							class='text-sm text-blue-600 font-bold underline'
						>
							Read Review
						</a>
					</div>

					<a
						href={casino.website_url}
						class='w-full bg-red-600 text-white font-bold py-3 rounded-lg text-center shadow-md'
					>
						Play Now &rarr;
					</a>
				</div>

				<div class='hidden md:grid grid-cols-12 gap-4 items-center p-4'>
					<div class='col-span-1 flex justify-center'>
						<div class='w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center'>
							{index + 1}
						</div>
					</div>

					<div class='col-span-5 flex items-center gap-4'>
						<img
							src={casino.logo_url || FALLBACK_ICON}
							alt={casino.name}
							class='w-12 h-12 object-contain rounded-lg border border-gray-100 p-1'
							onerror={`this.onerror=null; this.src='${FALLBACK_ICON}';`}
						/>
						<div>
							<a
								href={`/reviews/${casino.id}-casino`}
								class='font-bold text-lg text-slate-900 hover:text-blue-600'
							>
								{casino.name}
							</a>
							<div class='flex items-center gap-2 mt-1'>
								{casino.payments?.slice(0, 4).map((pm) => (
									<img
										src={pm.logo_url}
										alt={pm.name}
										class='h-5 w-auto grayscale hover:grayscale-0 transition-all opacity-70 hover:opacity-100'
										onerror={`this.onerror=null; this.src='${FALLBACK_ICON}';`}
									/>
								))}
							</div>
						</div>
					</div>

					<div class='col-span-3 text-center'>
						<span class='font-bold text-slate-900 block'>
							{casino.bonus_offer}
						</span>
						{(casino.bonus_spins || 0) > 0 && (
							<span class='text-xs text-red-600 font-bold'>
								+ {casino.bonus_spins} Free Spins
							</span>
						)}
					</div>

					<div class='col-span-1 text-center font-bold text-green-600 text-sm'>
						{casino.payout_speed_minutes}m
					</div>

					<div class='col-span-2 text-center'>
						<a
							href={casino.website_url}
							class='inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition-transform hover:scale-105 shadow-sm'
						>
							Play Now
						</a>
					</div>
				</div>
			</div>
		))
	}
</div>
