---
import { db } from '../../db/client';
import Button from './Button.astro';
import Badge from './Badge.astro';
import Heading from './Heading.astro';

// 1. Define Types
type Entity = { id: string; name: string; logo_url: string };

type Casino = {
	id: string;
	name: string;
	website_url: string;
	payout_ratio: number;
	payout_speed_minutes: number;
	logo_url: string;
	bonus_offer: string;
	bonus_spins: number;
    license: string;
	payments?: Entity[];
    software?: Entity[];
    min_deposit?: number;
};

// 2. Fetch Base Casinos
const topCasinosRaw = db
	.prepare('SELECT * FROM casinos ORDER BY payout_ratio DESC LIMIT 10')
	.all() as Casino[];

const casinoIds = topCasinosRaw.map((c) => c.id);

// 3. Fetch Relations (Payments & Software)
let allPayments: (Entity & { casino_id: string, min_deposit: number })[] = [];
let allSoftware: (Entity & { casino_id: string })[] = [];

if (casinoIds.length > 0) {
	const placeholders = casinoIds.map(() => '?').join(',');

    // Fetch Payments with Min Deposit info
	allPayments = db.prepare(`
        SELECT cpm.casino_id, pm.id, pm.name, pm.logo_url, pm.min_deposit
        FROM casino_payment_methods cpm
        JOIN payment_methods pm ON cpm.method_id = pm.id
        WHERE cpm.casino_id IN (${placeholders})
    `).all(...casinoIds) as (Entity & { casino_id: string, min_deposit: number | null })[];

    // Fetch Top Software Providers
    allSoftware = db.prepare(`
        SELECT cs.casino_id, sp.id, sp.name, sp.logo_url
        FROM casino_software cs
        JOIN software_providers sp ON cs.provider_id = sp.id
        WHERE cs.casino_id IN (${placeholders})
    `).all(...casinoIds) as (Entity & { casino_id: string })[];
}

// 4. Transform & Organize
const topCasinos = topCasinosRaw.map((casino) => {
	const methods = allPayments.filter((p) => p.casino_id === casino.id);
    const providers = allSoftware.filter((s) => s.casino_id === casino.id);

    // Calculate lowest deposit
    const minDeposit = methods.length > 0
        ? Math.min(...methods.map(m => m.min_deposit || 20))
        : 20;

    // Sort entities purely for consistent display
	const sortedMethods = methods.slice(0, 5); // Limit to 5
    const sortedSoftware = providers.slice(0, 4); // Limit to 4

	return {
        ...casino,
        payments: sortedMethods,
        software: sortedSoftware,
        min_deposit: minDeposit
    };
});

const FALLBACK_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzlDQTNBRiI+PHBhdGggZD0iTTEyIDFMMyA1djZjMCA1LjU1IDMuODQgMTAuNzQgOSAxMiA1LjE2LTEuMjYgOS02LjQ1IDktMTJWNWwtOS00em0wIDEwLjk5aDdjLS41MyA0LjEyLTMuMjggNy43OS03IDguOTRWMTJINVY2LjNsNy0zLjExdjguOHoiLz48L3N2Zz4=';
---

<div class='flex flex-col gap-4'>
	<!-- Desktop Header -->
	<div class='hidden lg:grid grid-cols-12 gap-4 bg-primary-50 p-card-sm rounded-t-card text-xs font-bold text-primary-600 uppercase tracking-wider border-b border-primary-200'>
		<div class='col-span-1 text-center'>Rank</div>
		<div class='col-span-4'>Casino & Key Stats</div>
		<div class='col-span-3'>Software & Banking</div>
		<div class='col-span-2 text-center'>Bonus</div>
		<div class='col-span-2 text-center'>Action</div>
	</div>

	{topCasinos.map((casino, index) => (
		<div class='bg-white rounded-card shadow-card border border-primary-200 overflow-hidden hover:shadow-card-hover transition-shadow relative'>

			<!-- MOBILE / TABLET VIEW (< 1024px) -->
			<div class='lg:hidden p-card flex flex-col gap-4'>
                <!-- Top Row: Logo, Rank, Name, Info -->
				<div class='flex items-start gap-4'>
                    <!-- Rank Badge -->
                    <div class='absolute top-0 left-0 bg-primary-900 text-white text-xs font-bold px-3 py-1 rounded-br-lg z-10'>
                        #{index + 1}
                    </div>

					<div class='w-24 h-24 flex-shrink-0 flex items-center justify-center mt-2 overflow-hidden rounded-card'>
						<img
							src={casino.logo_url || FALLBACK_ICON}
							alt={casino.name}
							class='w-full h-full object-contain rounded-card'
							onerror={`this.onerror=null; this.src='${FALLBACK_ICON}';`}
						/>
					</div>
					<div class="flex-grow pt-1">
						<Heading level={3} as="card-title" class="mb-1">
							{casino.name}
						</Heading>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <Badge variant="neutral" size="sm">{casino.license}</Badge>
                            <Badge variant="success" size="sm">
                                RTP {casino.payout_ratio}%
                            </Badge>
                        </div>
                        <Button
							href={`/reviews/${casino.id}-casino/`}
							variant="link"
							class='text-sm'
						>
                            Read Review &rarr;
                        </Button>
					</div>
				</div>

                <!-- Middle: Bonus Box -->
				<div class='bg-bonus-50 border border-bonus-100 rounded-btn p-3 text-center'>
					<span class='block text-xs font-bold text-bonus-700 uppercase tracking-wide mb-1'>Welcome Bonus</span>
					<span class='block text-lg font-black text-primary-900'>{casino.bonus_offer}</span>
				</div>

                <!-- Bottom: Specs & CTA -->
				<div class='flex flex-wrap items-center justify-between gap-4 border-t border-primary-200 pt-3'>
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-primary-600 font-bold">Fast Payouts</span>
                         <span class="text-sm font-bold text-primary-700">âš¡ {casino.payout_speed_minutes} mins</span>
                    </div>
					<Button
						href={casino.website_url}
						variant="primary"
						size="md"
						fullWidth
						class="sm:flex-grow-0"
					>
						Play Now
					</Button>
				</div>

                <!-- Expanded Info (Tablet Optimization) -->
                <div class="hidden sm:flex items-center gap-2 pt-2 overflow-hidden opacity-75">
                     <span class="text-xs font-bold text-primary-600">Software:</span>
                     {casino.software?.slice(0, 6).map(s => (
                        <img src={s.logo_url} class="h-12 w-auto grayscale" alt={s.name} />
                     ))}
                </div>
			</div>

			<!-- DESKTOP VIEW (>= 1024px) -->
			<div class='hidden lg:grid grid-cols-12 gap-4 items-center p-card-sm min-h-[100px]'>

                <!-- Rank -->
                <div class='col-span-1 flex justify-center'>
					<div class='w-10 h-10 rounded-badge bg-primary-100 text-primary-600 font-black text-lg flex items-center justify-center border border-primary-200'>
						{index + 1}
					</div>
				</div>

				<!-- Info -->
                <div class='col-span-4 flex items-center gap-4'>
					<div class='w-24 h-24 flex-shrink-0 flex items-center justify-center overflow-hidden rounded-card'>
						<img
							src={casino.logo_url || FALLBACK_ICON}
							alt={casino.name}
							class='w-full h-full object-contain rounded-card'
							onerror={`this.onerror=null; this.src='${FALLBACK_ICON}';`}
						/>
					</div>
					<div>
						<h3 class='text-xl font-bold text-primary-900 leading-none'>
							<a href={`/reviews/${casino.id}-casino/`} class='hover:text-accent-600 transition-colors'>
								{casino.name}
							</a>
						</h3>
						<div class='flex items-center gap-2 mt-1'>
                            <Badge variant="neutral" size="sm" title="License">
                                {casino.license}
                            </Badge>
                            <Badge variant="success" size="sm" border={false} title="Minimum Deposit">
                                ðŸ’° Min ${casino.min_deposit}
                            </Badge>
                            <Badge variant="info" size="sm" border={false} title="Payout Ratio">
                                ðŸ“ˆ {casino.payout_ratio}%
                            </Badge>
						</div>
					</div>
				</div>

                <!-- Logos (Software & Banking Mixed) -->
				<div class='col-span-3 flex flex-col justify-center gap-3'>
                   <div class="flex items-center gap-2 overflow-hidden">
                       <span class="text-[10px] uppercase font-bold text-primary-600 w-12 shrink-0">Games</span>
                       {casino.software?.map(s => (
                           <img src={s.logo_url} title={s.name} alt={s.name} class="h-16 w-auto object-contain grayscale hover:grayscale-0 opacity-80 hover:opacity-100 transition-all cursor-help" />
                       ))}
                   </div>
                   <div class="flex items-center gap-2 overflow-hidden">
                       <span class="text-[10px] uppercase font-bold text-primary-600 w-12 shrink-0">Bank</span>
                       {casino.payments?.map(p => (
                           <img src={p.logo_url} title={p.name} alt={p.name} class="h-6 w-auto object-contain" />
                       ))}
                   </div>
				</div>

                <!-- Bonus -->
				<div class='col-span-2 text-center flex flex-col justify-center'>
					<span class='font-bold text-primary-900 text-lg leading-tight'>{casino.bonus_offer}</span>
					{(casino.bonus_spins || 0) > 0 && (
						<Badge variant="accent" size="sm" class="mt-1 inline-block mx-auto">
							+ {casino.bonus_spins} Free Spins
						</Badge>
					)}
				</div>

                <!-- CTA -->
				<div class='col-span-2 flex flex-col gap-2 justify-center text-center'>
					<Button
						href={casino.website_url}
						variant="primary"
						size="md"
					>
						Play Now
					</Button>
                    <Button
						href={`/reviews/${casino.id}-casino/`}
						variant="link"
						class='text-xs'
					>
                        View Review
                    </Button>
				</div>
			</div>
		</div>
	))}
</div>
