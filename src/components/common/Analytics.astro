---
// src/components/common/Analytics.astro
// Environment variables (prefixed with PUBLIC_ to be available in the browser)
const GA_MEASUREMENT_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
const GSC_VERIFICATION_CODE = import.meta.env.PUBLIC_GSC_VERIFICATION_CODE;
---

<!-- Google Search Console Verification -->
{
	GSC_VERIFICATION_CODE && (
		<meta name='google-site-verification' content={GSC_VERIFICATION_CODE} />
	)
}

<!-- Google Analytics 4 (Respects Cookie Consent) -->
{
	GA_MEASUREMENT_ID && (
		<>
			<script
				async
				src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}
			></script>
			<script define:vars={{ GA_MEASUREMENT_ID }}>
				window.dataLayer = window.dataLayer || [];
				function gtag() {
					dataLayer.push(arguments);
				}

				// Check if user has consented to cookies
				function initializeAnalytics() {
					const consent = localStorage.getItem('cookie-consent');
					if (consent === 'accepted') {
						gtag('js', new Date());
						gtag('config', GA_MEASUREMENT_ID, {
							anonymize_ip: true, // PIPEDA compliance for Canadian users
							cookie_flags: 'SameSite=None;Secure',
						});
					}
				}

				// Initialize if already consented
				initializeAnalytics();

				// Listen for consent changes
				window.addEventListener('storage', (e) => {
					if (e.key === 'cookie-consent' && e.newValue === 'accepted') {
						initializeAnalytics();
					}
				});
			</script>
		</>
	)
}
